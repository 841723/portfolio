---
import DirectionsIcon from './icons/Directions.astro';
import LockIcon from './icons/Lock.astro';
import { getCollection } from 'astro:content';
import Section from './Section.astro';
const allWriteups = await getCollection('writeups');

allWriteups.sort((a, b) => {

    const today = new Date();

    const dateA = a.data.releasedDate ? new Date(a.data.releasedDate) : null;
    const dateB = b.data.releasedDate ? new Date(b.data.releasedDate) : null;

    const isPastA = dateA && dateA < today;
    const isPastB = dateB && dateB < today;

    // Ordenar primero por releasedDate: pasado < futuro o undefined
    if (isPastA && !isPastB) return -1;
    if (!isPastA && isPastB) return 1;

    // releasedDate en el mismo grupo: ordenar por dificultad
    const difficultyOrder = {
        easy: 4,
        medium: 3,
        hard: 2,
        insane: 1
    };

    const difficultyA = difficultyOrder[a.data.difficulty] || 0;
    const difficultyB = difficultyOrder[b.data.difficulty] || 0;

    if (difficultyA !== difficultyB) {
        return difficultyA - difficultyB;
    }

    // Si la dificultad es la misma, ordenar por fecha descendente
    const hasDateA = !!a.data.date;
    const hasDateB = !!b.data.date;

    if (!hasDateA && !hasDateB) return 0;
    if (!hasDateA) return 1;
    if (!hasDateB) return -1;

    return new Date(b.data.date || '').getTime() - new Date(a.data.date || '').getTime();
});
---
<Section
    title="Write Ups"
    id="writeups"
>
    <DirectionsIcon slot="icon" />
    <p class="text-lg">
        Here you can find some writeups of Hack The Box machines that I have solved. These writeups are meant to help others learn and understand the process of solving these machines.
    </p>
    <p class="text-lg">
        Feel free to reach out if you have any questions or suggestions for future writeups.
    </p>
    <hr class="border-gray-400 border-2 my-8" />
    { allWriteups.length === 0 ? (
        <p class="text-md italic">No writeups available at the moment.</p>
    ) : (
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-8 px-2 md:px-0">
            {allWriteups.map((writeup) => (
                <a
                    href={`/portfolio/writeups/${writeup.id}`}
                    class="relative flex flex-col items-center justify-between bg-gray-800 rounded-lg p-4 hover:bg-gray-700 transition-colors"
                >
                    {
                        (!writeup.data.releasedDate || !(new Date(writeup.data.releasedDate) < new Date())) && (
                        <picture class="absolute top-2 right-2 opacity-50" >
                            <LockIcon/>
                        </picture>)
                    }
                    <picture class="h-32 md:h-40 aspect-square flex items-center justify-center">
                        <img 
                            class="rounded-lg h-32 md:h-40 object-cover"
                            src={writeup.data.img}
                            alt={writeup.data.name}
                            style={`view-transition-name: writeup-image-${writeup.id}`}
                        />
                    </picture>
                    <h2 
                        class="text-2xl font-bold my-4 text-center"
                        style={`view-transition-name: writeup-name-${writeup.id}`}
                    >{writeup.data.name}</h2>
                    <p 
                        class="text-sm font-normal"
                        style={`view-transition-name: writeup-diff-${writeup.id}`}
                    >
                        Difficulty: 
                        <span class={`font-semibold ${writeup.data.difficulty === 'easy' ? 'text-green-500' : writeup.data.difficulty === 'medium' ? 'text-yellow-500' : writeup.data.difficulty === 'hard' ? 'text-red-500' : 'text-purple-500'}`}>
                            {writeup.data.difficulty.charAt(0).toUpperCase() + writeup.data.difficulty.slice(1)}
                        </span>
                    </p>
                    <p 
                        class="text-sm font-normal"
                        style={`view-transition-name: writeup-os-${writeup.id}`}
                    >
                        OS: 
                        <span class="font-semibold">{writeup.data.os.charAt(0).toUpperCase() + writeup.data.os.slice(1)}</span>
                    </p>
                </a>
            ))}
        </div>
    )}
</Section>